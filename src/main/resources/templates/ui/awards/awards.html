<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Награды - Кинотека</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="page-header">
            <h1><i class="fas fa-award"></i> Награды</h1>
            <p class="page-subtitle">Кинопремии и награды фильмов, актёров и режиссёров</p>
        </div>

        <!-- Фильтрация наград -->
        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="fas fa-filter"></i> Фильтрация наград</h2>
            </div>
            <div class="card-body">
                <div class="filter-section">
                    <div class="row" style="display: flex; gap: 1rem; align-items: center;">
                        <div class="col" style="flex: 1;">
                            <input type="text" 
                                   id="awardType" 
                                   class="form-control" 
                                   placeholder="Тип награды (например: Academy, Cannes, Golden Globe)">
                        </div>
                        <div class="col-auto">
                            <button id="awardFilterBtn" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Фильтровать
                            </button>
                            <button id="awardRefreshBtn" class="btn btn-outline">
                                <i class="fas fa-redo"></i> Показать все
                            </button>
                        </div>
                    </div>
                    
                    <!-- Быстрые фильтры -->
                    <div class="quick-filters mt-3">
                        <span class="filter-label">Быстрые фильтры:</span>
                        <div class="filter-chips">
                            <button class="filter-chip" onclick="filterByType('Academy')">
                                <i class="fas fa-trophy"></i> Academy Awards
                            </button>
                            <button class="filter-chip" onclick="filterByType('Cannes')">
                                <i class="fas fa-palette"></i> Cannes
                            </button>
                            <button class="filter-chip" onclick="filterByType('Golden Globe')">
                                <i class="fas fa-globe"></i> Golden Globe
                            </button>
                            <button class="filter-chip" onclick="filterByType('BAFTA')">
                                <i class="fas fa-crown"></i> BAFTA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика наград -->
        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="fas fa-chart-bar"></i> Статистика</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid" id="awardsStats">
                    <!-- Статистика загрузится через JS -->
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список наград -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-list"></i> Список наград</h2>
                <span class="badge" id="awardsCount">0 наград</span>
            </div>
            <div class="card-body">
                <div class="loading" id="awardsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="awards-table-container">
                    <table class="table" id="awardsTable">
                        <thead>
                            <tr>
                                <th><i class="fas fa-trophy"></i> Награда</th>
                                <th><i class="fas fa-tag"></i> Тип</th>
                                <th><i class="fas fa-calendar"></i> Год</th>
                                <th><i class="fas fa-info-circle"></i> Описание</th>
                                <th><i class="fas fa-film"></i> Фильм</th>
                            </tr>
                        </thead>
                        <tbody id="awardsList">
                            <!-- Награды загрузятся через JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        let allAwards = [];
        
        async function loadAwards() {
            showLoading('awardsLoading');
            const res = await apiGet('/movies/awards');
            hideLoading('awardsLoading');
            
            if (res.ok && res.data) {
                allAwards = res.data;
                renderAwards(allAwards);
                updateStats(allAwards);
            } else {
                document.getElementById('awardsList').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Ошибка загрузки наград
                        </td>
                    </tr>
                `;
            }
        }
        
        async function filterAwards(type) {
            showLoading('awardsLoading');
            const res = await apiGet(`/movies/awards/type/${encodeURIComponent(type)}`);
            hideLoading('awardsLoading');
            
            if (res.ok) {
                renderAwards(res.data || []);
                document.getElementById('awardType').value = type;
            }
        }
        
        function renderAwards(awards) {
            const tbody = document.getElementById('awardsList');
            tbody.innerHTML = '';
            
            if (awards.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Награды не найдены
                        </td>
                    </tr>
                `;
                document.getElementById('awardsCount').textContent = '0 наград';
                return;
            }
            
            document.getElementById('awardsCount').textContent = `${awards.length} наград`;
            
            awards.forEach(award => {
                const row = document.createElement('tr');
                row.className = 'award-row fade-in';
                row.innerHTML = `
                    <td>
                        <div class="award-name">
                            <i class="fas fa-trophy" style="color: #ffd700;"></i>
                            ${award.name || 'Не указано'}
                        </div>
                    </td>
                    <td>
                        <span class="award-type-badge" style="background: ${getAwardTypeColor(award.awardType)}">
                            ${award.awardType || 'Не указан'}
                        </span>
                    </td>
                    <td>
                        ${award.year || '—'}
                    </td>
                    <td>
                        <div class="award-description">
                            ${award.awardDescription ? 
                              (award.awardDescription.length > 50 ? 
                               award.awardDescription.substring(0, 50) + '...' : 
                               award.awardDescription) : 
                              '<span class="text-muted">Нет описания</span>'}
                        </div>
                    </td>
                    <td>
                        ${award.movie ? 
                          `<a href="/ui/movies/${award.movie.id}" class="movie-link">
                            ${award.movie.name}
                           </a>` : 
                          '<span class="text-muted">Не связан</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateStats(awards) {
            const statsDiv = document.getElementById('awardsStats');
            
            // Группировка по типу
            const typeCounts = {};
            const yearCounts = {};
            awards.forEach(award => {
                const type = award.awardType || 'Без типа';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
                
                if (award.year) {
                    yearCounts[award.year] = (yearCounts[award.year] || 0) + 1;
                }
            });
            
            // Находим самый частый тип и год
            const mostCommonType = Object.keys(typeCounts).reduce((a, b) => 
                typeCounts[a] > typeCounts[b] ? a : b, 'Нет данных');
            const mostCommonYear = Object.keys(yearCounts).reduce((a, b) => 
                yearCounts[a] > yearCounts[b] ? a : b, 'Нет данных');
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${awards.length}</div>
                        <div class="stat-label">Всего наград</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${Object.keys(typeCounts).length}</div>
                        <div class="stat-label">Разных типов</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${mostCommonType}</div>
                        <div class="stat-label">Самый частый тип</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-star"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${mostCommonYear}</div>
                        <div class="stat-label">Самый частый год</div>
                    </div>
                </div>
            `;
        }
        
        function getAwardTypeColor(type) {
            const colors = {
                'Academy': '#ff6b6b',
                'Cannes': '#4ecdc4',
                'Golden Globe': '#ffe66d',
                'BAFTA': '#1a535c',
                'Oscar': '#ffd166',
                'Emmy': '#06d6a0',
                'Default': '#6a89cc'
            };
            return colors[type] || colors['Default'];
        }
        
        function filterByType(type) {
            document.getElementById('awardType').value = type;
            filterAwards(type);
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadAwards();
            
            document.getElementById('awardFilterBtn').addEventListener('click', () => {
                const type = document.getElementById('awardType').value.trim();
                if (type) {
                    filterAwards(type);
                } else {
                    renderAwards(allAwards);
                    updateStats(allAwards);
                }
            });
            
            document.getElementById('awardRefreshBtn').addEventListener('click', () => {
                document.getElementById('awardType').value = '';
                renderAwards(allAwards);
                updateStats(allAwards);
            });
            
            document.getElementById('awardType').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const type = e.target.value.trim();
                    if (type) {
                        filterAwards(type);
                    }
                }
            });
        });
        
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'flex';
        }
        
        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'none';
        }
    </script>

    <style>
        .filter-section {
            margin-bottom: 1rem;
        }
        
        .filter-label {
            color: #6a89cc;
            font-weight: 600;
            margin-right: 1rem;
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .filter-chip {
            padding: 0.5rem 1rem;
            background: #f8faff;
            border: 1px solid #e0e7ff;
            border-radius: 50px;
            color: #6a89cc;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .filter-chip:hover {
            background: #4a69bd;
            color: white;
            border-color: #4a69bd;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(74, 105, 189, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #82ccdd 0%, #60a3bc 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4a69bd;
            line-height: 1;
        }
        
        .stat-label {
            color: #6a89cc;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        .awards-table-container {
            overflow-x: auto;
        }
        
        .award-row {
            transition: all 0.3s ease;
        }
        
        .award-row:hover {
            background: #f8faff;
        }
        
        .award-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #4a69bd;
        }
        
        .award-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .award-description {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .movie-link {
            color: #4a69bd;
            text-decoration: none;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #f0f4ff;
            transition: all 0.3s ease;
        }
        
        .movie-link:hover {
            background: #4a69bd;
            color: white;
        }
        
        .badge {
            background: linear-gradient(135deg, #82ccdd 0%, #60a3bc 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-chips {
                justify-content: center;
            }
        }
    </style>
</body>
</html>